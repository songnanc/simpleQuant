queue()
    //.defer(d3.json, "/static/json/profits.json")
    .defer(d3.json, "/static/json/hqData.json")
    .await(stockHistoryPriceChart);

function stockHistoryPriceChart(error, hqData) {
  var hitslineChart = dc.lineChart("#chart--history-price");

	var data = [{
	  "status": 0,
	  "hq": [
	    ["2016-01-04", "14.10", "12.70", "-1.41", "-9.99%", "12.70", "14.10", "85601", "11253.98", "2.11%"],
	    ["2015-12-31", "14.64", "14.11", "-0.46", "-3.16%", "14.10", "14.77", "71789", "10328.96", "1.77%"],
	    ["2015-12-30", "14.61", "14.57", "-0.04", "-0.27%", "14.40", "14.75", "74664", "10875.69", "1.84%"],
	    ["2015-12-29", "14.39", "14.61", "0.23", "1.60%", "14.10", "14.63", "86794", "12477.82", "2.14%"],
	    ["2015-12-28", "15.47", "14.38", "-1.01", "-6.56%", "14.25", "15.49", "190619", "28125.17", "4.70%"],
	    ["2015-12-25", "15.70", "15.39", "-0.31", "-1.97%", "15.20", "15.99", "131354", "20444.87", "3.24%"],
	    ["2015-12-24", "16.80", "15.70", "-1.04", "-6.21%", "15.52", "16.91", "267987", "42652.21", "6.61%"],
	    ["2015-12-23", "15.10", "16.74", "1.52", "9.99%", "15.10", "16.74", "174314", "28340.73", "4.30%"],
	    ["2015-12-22", "15.65", "15.22", "0.31", "2.08%", "15.15", "16.29", "191084", "29549.53", "4.71%"],
	    ["2015-12-21", "14.49", "14.91", "0.41", "2.83%", "14.37", "15.25", "147694", "21961.41", "3.64%"],
	    ["2015-12-18", "14.58", "14.50", "-0.15", "-1.02%", "14.26", "14.80", "122017", "17665.33", "3.01%"],
	    ["2015-12-17", "13.99", "14.65", "0.67", "4.79%", "13.99", "14.95", "185449", "26698.37", "4.57%"],
	    ["2015-12-16", "14.17", "13.98", "-0.22", "-1.55%", "13.90", "14.48", "94562", "13408.98", "2.33%"],
	    ["2015-12-15", "14.02", "14.20", "0.12", "0.85%", "13.82", "14.35", "112924", "15860.58", "2.78%"],
	    ["2015-12-14", "13.24", "14.08", "0.49", "3.61%", "13.20", "14.09", "116464", "16216.36", "2.87%"],
	    ["2015-12-11", "13.20", "13.59", "0.31", "2.33%", "13.02", "13.68", "64001", "8553.41", "1.58%"],
	    ["2015-12-10", "13.06", "13.28", "0.01", "0.08%", "12.91", "13.49", "78277", "10338.70", "1.93%"],
	    ["2015-12-09", "13.91", "13.27", "-0.63", "-4.53%", "13.13", "13.91", "95040", "12902.08", "2.34%"],
	    ["2015-12-08", "13.89", "13.90", "0.10", "0.72%", "13.66", "14.27", "149691", "20900.85", "3.69%"],
	    ["2015-12-07", "13.60", "13.80", "0.40", "2.99%", "13.60", "14.35", "110865", "15434.81", "2.73%"],
	    ["2015-12-04", "12.90", "13.40", "0.30", "2.29%", "12.90", "13.68", "125378", "16806.15", "3.09%"],
	    ["2015-12-03", "12.79", "13.10", "0.31", "2.42%", "12.70", "13.15", "84146", "10944.65", "2.07%"],
	    ["2015-12-02", "13.02", "12.79", "-0.49", "-3.69%", "12.41", "13.26", "105939", "13510.61", "2.61%"],
	    ["2015-12-01", "12.80", "13.28", "0.28", "2.15%", "12.50", "13.70", "139099", "18500.99", "3.43%"],
	    ["2015-11-30", "13.85", "13.00", "-0.75", "-5.45%", "12.38", "13.95", "221371", "28469.37", "5.46%"],
	    ["2015-11-27", "14.15", "13.75", "-0.38", "-2.69%", "13.50", "14.80", "218697", "31175.35", "5.39%"],
	    ["2015-11-26", "14.09", "14.13", "0.01", "0.07%", "13.92", "14.42", "122919", "17481.98", "3.03%"],
	    ["2015-11-25", "13.69", "14.12", "0.41", "2.99%", "13.65", "14.33", "125377", "17571.86", "3.09%"],
	    ["2015-11-24", "13.49", "13.71", "0.16", "1.18%", "13.40", "13.72", "66049", "8974.90", "1.63%"],
	    ["2015-11-23", "13.60", "13.55", "-0.21", "-1.53%", "13.40", "14.11", "94555", "12964.40", "2.33%"],
	    ["2015-11-20", "13.69", "13.76", "0.06", "0.44%", "13.60", "14.13", "105015", "14544.34", "2.59%"],
	    ["2015-11-19", "13.32", "13.70", "0.30", "2.24%", "13.32", "13.80", "88589", "12047.51", "2.18%"],
	    ["2015-11-18", "14.08", "13.40", "-0.59", "-4.22%", "13.33", "14.16", "94771", "13050.20", "2.34%"],
	    ["2015-11-17", "14.38", "13.99", "-0.30", "-2.10%", "13.87", "14.80", "163848", "23485.34", "4.04%"],
	    ["2015-11-16", "13.35", "14.29", "0.63", "4.61%", "13.32", "14.39", "126714", "17580.34", "3.12%"],
	    ["2015-11-13", "13.80", "13.66", "-0.47", "-3.33%", "13.40", "14.00", "159452", "21878.42", "3.93%"],
	    ["2015-11-12", "14.33", "14.13", "-0.42", "-2.89%", "13.85", "14.77", "287542", "40894.68", "7.09%"],
	    ["2015-11-11", "13.60", "14.55", "1.02", "7.54%", "13.58", "14.88", "396022", "57430.03", "9.76%"],
	    ["2015-11-10", "13.10", "13.53", "0.24", "1.81%", "13.04", "13.94", "251937", "33953.28", "6.21%"],
	    ["2015-11-09", "13.15", "13.29", "-0.18", "-1.34%", "12.90", "13.73", "221774", "29335.97", "5.47%"],
	    ["2015-11-06", "12.70", "13.47", "0.57", "4.42%", "12.65", "13.87", "256913", "34624.44", "6.33%"],
	    ["2015-11-05", "12.46", "12.90", "0.52", "4.20%", "12.10", "12.98", "244134", "30517.88", "6.02%"],
	    ["2015-11-04", "11.66", "12.38", "0.78", "6.72%", "11.66", "12.46", "167166", "20223.20", "4.12%"],
	    ["2015-11-03", "11.92", "11.60", "-0.35", "-2.93%", "11.32", "12.13", "143785", "16824.46", "3.55%"],
	    ["2015-11-02", "12.00", "11.95", "-0.69", "-5.46%", "11.66", "12.84", "224950", "27362.74", "5.55%"],
	    ["2015-10-30", "13.10", "12.64", "-0.31", "-2.39%", "12.45", "13.43", "413337", "53492.13", "10.19%"],
	    ["2015-10-29", "11.85", "12.95", "1.18", "10.03%", "11.83", "12.95", "355985", "45521.71", "8.78%"],
	    ["2015-10-28", "11.90", "11.77", "-0.18", "-1.51%", "11.70", "12.48", "155600", "18755.92", "3.84%"],
	    ["2015-10-27", "11.89", "11.95", "-0.07", "-0.58%", "11.20", "12.06", "158481", "18522.36", "3.91%"],
	    ["2015-10-26", "12.36", "12.02", "-0.35", "-2.83%", "11.72", "12.36", "192849", "23144.41", "4.76%"],
	    ["2015-10-23", "11.70", "12.37", "0.69", "5.91%", "11.68", "12.50", "264714", "32232.64", "6.53%"],
	    ["2015-10-22", "10.90", "11.68", "0.82", "7.55%", "10.86", "11.80", "221162", "25345.51", "5.45%"],
	    ["2015-10-21", "12.07", "10.86", "-1.21", "-10.02%", "10.86", "12.54", "210108", "24350.45", "5.18%"],
	    ["2015-10-20", "12.00", "12.07", "-0.03", "-0.25%", "11.69", "12.15", "205538", "24548.52", "5.07%"],
	    ["2015-10-19", "11.20", "12.10", "0.95", "8.52%", "11.02", "12.15", "287904", "33530.79", "7.10%"],
	    ["2015-10-16", "10.51", "11.15", "0.67", "6.39%", "10.45", "11.24", "207309", "22427.74", "5.11%"],
	    ["2015-10-15", "9.98", "10.48", "0.43", "4.28%", "9.92", "10.50", "121549", "12542.63", "3.00%"],
	    ["2015-10-14", "10.42", "10.05", "-0.37", "-3.55%", "10.03", "10.55", "107091", "10980.12", "2.64%"],
	    ["2015-10-13", "10.20", "10.42", "0.11", "1.07%", "10.18", "10.73", "123974", "12949.08", "3.06%"],
	    ["2015-10-12", "9.90", "10.31", "0.53", "5.42%", "9.79", "10.46", "134278", "13631.00", "3.31%"],
	    ["2015-10-09", "9.49", "9.78", "0.32", "3.38%", "9.40", "9.88", "84781", "8196.15", "2.09%"],
	    ["2015-10-08", "9.52", "9.46", "0.36", "3.96%", "9.32", "9.63", "68127", "6464.64", "1.68%"],
	    ["2015-09-30", "9.14", "9.10", "0.06", "0.66%", "9.03", "9.19", "49157", "4475.50", "1.21%"],
	    ["2015-09-29", "9.28", "9.04", "-0.47", "-4.94%", "9.02", "9.35", "62404", "5721.47", "1.54%"],
	    ["2015-09-28", "9.40", "9.51", "0.17", "1.82%", "8.98", "9.53", "65128", "6085.56", "1.61%"],
	    ["2015-09-25", "9.65", "9.34", "-0.31", "-3.21%", "9.19", "10.08", "142981", "13853.61", "3.53%"],
	    ["2015-09-24", "9.50", "9.65", "0.27", "2.88%", "9.40", "9.72", "96823", "9261.40", "2.39%"],
	    ["2015-09-23", "9.31", "9.38", "-0.29", "-3.00%", "9.22", "9.66", "97193", "9187.99", "2.40%"],
	    ["2015-09-22", "9.52", "9.67", "0.09", "0.94%", "9.52", "9.85", "106132", "10273.95", "2.62%"],
	    ["2015-09-21", "9.12", "9.58", "0.31", "3.34%", "9.00", "9.62", "100747", "9431.48", "2.48%"],
	    ["2015-09-18", "9.17", "9.27", "0.29", "3.23%", "8.99", "9.45", "95968", "8840.39", "2.37%"],
	    ["2015-09-17", "9.00", "8.98", "0.00", "0.00%", "8.80", "9.70", "159394", "14727.60", "3.93%"],
	    ["2015-09-16", "8.31", "8.98", "0.82", "10.05%", "8.23", "8.98", "111977", "9591.29", "2.76%"],
	    ["2015-09-15", "8.91", "8.16", "-0.89", "-9.83%", "8.15", "8.95", "139024", "11747.06", "3.43%"],
	    ["2015-09-14", "10.19", "9.05", "-1.00", "-9.95%", "9.05", "10.69", "177618", "17639.42", "4.38%"],
	    ["2015-09-11", "9.88", "10.05", "0.19", "1.93%", "9.41", "10.09", "110895", "10887.33", "2.73%"],
	    ["2015-09-10", "10.14", "9.86", "-0.49", "-4.73%", "9.81", "10.45", "112833", "11419.08", "2.78%"],
	    ["2015-09-09", "10.01", "10.35", "0.37", "3.71%", "9.94", "10.47", "167183", "17097.59", "4.12%"],
	    ["2015-09-08", "9.16", "9.98", "0.69", "7.43%", "9.16", "10.10", "114030", "10929.65", "2.81%"],
	    ["2015-09-07", "9.00", "9.29", "0.42", "4.74%", "8.98", "9.47", "104009", "9605.00", "2.56%"]
	  ],
	  "code": "cn_000045"
	}];
	var ndx = crossfilter(data[0].hq);
	var parseDate = d3.time.format("%Y-%m-%d").parse;
	data[0].hq.forEach(function(d) {
	  d.date = parseDate(d[0]);
	  d.open = d[1];
    d.close = d[2];
	});

	var dateDim = ndx.dimension(function(d) {
	  return d.date;
	});
	var open = dateDim.group().reduceSum(function(d) {
	  return d.open;
	});
  var close = dateDim.group().reduceSum(function(d) {
	  return d.close;
	});
	var minDate = dateDim.bottom(1)[0].date;
	var maxDate = dateDim.top(1)[0].date;

	hitslineChart
	  .width(800).height(200)
	  .dimension(dateDim)
	  .group(open, "open")
    .group(close, "close")
	  .x(d3.time.scale().domain([minDate, maxDate]))
	  .yAxisLabel("Price")
    .title(function(d){ return getvalues(d);}) 
    .legend(dc.legend().x(50).y(10).itemHeight(13).gap(5))
	  .brushOn(false);
    
function getvalues(d){
    return d.key.getFullYear() + "/" + (d.key.getMonth() + 1) + "/" + d.key.getDate() + ": " + d.value;
} 

	dc.renderAll();


};
function makeGraphs(error, projectsJson, statesJson) {
	
	//Clean projectsJson data
	var donorschooseProjects = projectsJson;
	var dateFormat = d3.time.format("%Y-%m-%d");
	donorschooseProjects.forEach(function(d) {
		d["date_posted"] = dateFormat.parse(d["date_posted"]);
		d["date_posted"].setDate(1);
		d["total_donations"] = +d["total_donations"];
	});

	//Create a Crossfilter instance
	var ndx = crossfilter(donorschooseProjects);

	//Define Dimensions
	var dateDim = ndx.dimension(function(d) { return d["date_posted"]; });
	var resourceTypeDim = ndx.dimension(function(d) { return d["resource_type"]; });
	var povertyLevelDim = ndx.dimension(function(d) { return d["poverty_level"]; });
	var stateDim = ndx.dimension(function(d) { return d["school_state"]; });
	var totalDonationsDim  = ndx.dimension(function(d) { return d["total_donations"]; });


	//Calculate metrics
	var numProjectsByDate = dateDim.group(); 
	var numProjectsByResourceType = resourceTypeDim.group();
	var numProjectsByPovertyLevel = povertyLevelDim.group();
	var totalDonationsByState = stateDim.group().reduceSum(function(d) {
		return d["total_donations"];
	});

	var all = ndx.groupAll();
	var totalDonations = ndx.groupAll().reduceSum(function(d) {return d["total_donations"];});

	var max_state = totalDonationsByState.top(1)[0].value;

	//Define values (to be used in charts)
	var minDate = dateDim.bottom(1)[0]["date_posted"];
	var maxDate = dateDim.top(1)[0]["date_posted"];

    //Charts
	var timeChart = dc.barChart("#time-chart");
	var resourceTypeChart = dc.rowChart("#resource-type-row-chart");
	var povertyLevelChart = dc.rowChart("#poverty-level-row-chart");
	var usChart = dc.geoChoroplethChart("#us-chart");
	var numberProjectsND = dc.numberDisplay("#number-projects-nd");
	var totalDonationsND = dc.numberDisplay("#total-donations-nd");

	numberProjectsND
		.formatNumber(d3.format("d"))
		.valueAccessor(function(d){return d; })
		.group(all);

	totalDonationsND
		.formatNumber(d3.format("d"))
		.valueAccessor(function(d){return d; })
		.group(totalDonations)
		.formatNumber(d3.format(".3s"));

	timeChart
		.width(600)
		.height(160)
		.margins({top: 10, right: 50, bottom: 30, left: 50})
		.dimension(dateDim)
		.group(numProjectsByDate)
		.transitionDuration(500)
		.x(d3.time.scale().domain([minDate, maxDate]))
		.elasticY(true)
		.xAxisLabel("Year")
		.yAxis().ticks(4);

	resourceTypeChart
        .width(300)
        .height(250)
        .dimension(resourceTypeDim)
        .group(numProjectsByResourceType)
        .xAxis().ticks(4);

	povertyLevelChart
		.width(300)
		.height(250)
        .dimension(povertyLevelDim)
        .group(numProjectsByPovertyLevel)
        .xAxis().ticks(4);


	usChart.width(1000)
		.height(330)
		.dimension(stateDim)
		.group(totalDonationsByState)
		.colors(["#E2F2FF", "#C4E4FF", "#9ED2FF", "#81C5FF", "#6BBAFF", "#51AEFF", "#36A2FF", "#1E96FF", "#0089FF", "#0061B5"])
		.colorDomain([0, max_state])
		.overlayGeoJson(statesJson["features"], "state", function (d) {
			return d.properties.name;
		})
		.projection(d3.geo.albersUsa()
    				.scale(600)
    				.translate([340, 150]))
		.title(function (p) {
			return "State: " + p["key"]
					+ "\n"
					+ "Total Donations: " + Math.round(p["value"]) + " $";
		})

    dc.renderAll();

};